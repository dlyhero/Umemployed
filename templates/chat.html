{% extends 'base.html' %}
{% load static %}
{% block title %}
    <title>Chat | UmEmployed</title>
{% endblock title %}
{% block custom_css %}
<style>
  body{
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
  }

  /* Updated chat container for professional look */
  .chat-container {


   flex-grow: 1;
  }

  .chat-header {
    font-size: 28px;
    font-weight: bold;
    margin-bottom: 30px;
    text-align: center;
    color: #333;
  }

  #messagess {
    flex: 1;
    overflow-y: auto;
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    padding: 10px;
  }

  .message {
    padding: 12px 16px;
    border-radius: 16px;
    margin-bottom: 12px;
    max-width: 60%;
    word-wrap: break-word;
  }

  .message-sent {
    background-color: #e0f7fa;
    align-self: flex-end;
    text-align: right;
    color: #00695c;
  }

  .message-received {
    background-color: #f1f1f1;
    align-self: flex-start;
    text-align: left;
    color: #333;
  }

  #chat-form {
    display: flex;
    align-items: center;
    padding: 10px 0;
    background-color: #ffffff;
    position: sticky;
    bottom: 0;
  }


  /* Remove page scroll */
  html, body {
    overflow: hidden;
  }

  /* Mobile responsiveness */
  @media (max-width: 768px) {
    .chat-container {
      padding: 15px;
    }

    .chat-header {
      font-size: 22px;
    }

    #chat-message-input {
      padding: 10px;
    }

    #chat-message-submit {
      padding: 10px 18px;
    }
  }
</style>
{% endblock custom_css %}
{% block messagess %}
        <!-- Intentionally left blank to disable messagess display -->
{% endblock messagess %}
{% block content %}

<div class="chat-container container mx-auto bg-white  flex flex-col">
  <h2 class="chat-header rounded-full text-xl font-bold text-gray-800 bg-gray-100 p-4 border-b flex items-center justify-between">
    <div class="flex items-center space-x-3">
      <!-- Use Font Awesome Icon as a placeholder for the profile picture -->
      <i class="fas fa-user w-10 h-10 rounded-full bg-blue-200 text-blue-600 flex items-center justify-center text-xl"></i>
      <span class="truncate w-[200px] md:w-full">
        Chat with 
        {% if conversation.participant2 == request.user %}
          {{ conversation.participant1 }}
        {% else %}
          {{ conversation.participant2 }}
        {% endif %}
      </span>
    </div>
    <span class="text-sm text-gray-500">{{ conversation.last_updated|date:"M d, Y h:i A" }}</span>
  </h2>

  <div id="messagess" class="flex-1 overflow-y-auto p-4 space-y-4 ">
    {% for message in messagess %}
      <div class="message {% if message.sender == request.user %}message-sent self-end bg-blue-100 text-blue-800{% else %}message-received self-start bg-gray-100 text-gray-800{% endif %} rounded-lg p-3 max-w-[70%]">
        <div class="flex items-start space-x-3">
          <!-- Use Font Awesome Icon as a placeholder for the sender's profile picture -->
          <i class="fas fa-user w-8 h-8 rounded-full bg-blue-200 text-blue-600 flex items-center justify-center text-xl"></i>
          <div>
            <strong class="block text-sm font-semibold">{{ message.sender.first_name }}:</strong>
            <p class="text-sm">{{ message.text }}</p>
            {% if message.attachment %}
              <a href="{{ message.attachment.url }}" class="text-blue-500 text-sm underline">Attachment</a>
            {% endif %}
            <span class="block text-xs text-gray-400 mt-1">{{ message.timestamp|date:"h:i A" }}</span>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <form id="chat-form" method="post" action="{% url 'messaging:send_message' conversation.id %}" class="w-full flex items-center border-t bg-gray-50 p-4">
    {% csrf_token %}
    <button type="button" class="text-gray-500 mr-3" aria-label="Attach File">
      <i class="fas fa-paperclip text-xl"></i>
    </button>
    <button type="button" class="text-gray-500 mr-3" aria-label="Add Emoji">
      <i class="fas fa-smile text-xl"></i>
    </button>
    <input 
      type="text" 
      id="chat-message-input" 
      name="text" 
      placeholder="Type your message..." 
      class="flex-1 px-4 py-2 mr-2 border rounded-full shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
      aria-label="Message Input">
    <button 
      type="submit" 
      
      class=" text-[#1e90ff]"
      aria-label="Send Message"
    >
    <i class="fas fa-paper-plane text-3xl"></i> 
    </button>
  </form>
</div>

<script>
    const conversationId = "{{ conversation.id }}";
    let chatSocket;

    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
         chatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/' + conversationId + '/');

        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            if (data.sender === '{{ request.user.username }}') {
                messageDiv.classList.add('message-sent');
            } else {
                messageDiv.classList.add('message-received');
            }
            messageDiv.innerHTML = `<strong>${data.sender}:</strong> ${data.message}`;
            document.querySelector('#messagess').appendChild(messageDiv);
            document.querySelector('#messagess').scrollTop = document.querySelector('#messagess').scrollHeight;
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly. Reconnecting...');
            setTimeout(connectWebSocket, 1000); // Retry connection after 1 second
        };
    }

    connectWebSocket();

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function(e) {
        if (e.keyCode === 13) {  // Enter key
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function(e) {
        e.preventDefault();
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value.trim();

        if (message) {
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender': '{{ request.user.username }}'
            }));
            messageInputDom.value = '';
        }
    };

     // Function to scroll to the bottom of the messages container
  function scrollToBottom() {
    var messageContainer = document.getElementById('messagess');
    messageContainer.scrollTop = messageContainer.scrollHeight;
  }

  // Scroll to the bottom when the page is loaded
  window.onload = function() {
    scrollToBottom();
  };

  // Optionally, you can trigger this function after new messages are sent
  const chatForm = document.getElementById('chat-form');
  chatForm.addEventListener('submit', function() {
    setTimeout(scrollToBottom, 100);  // Scroll after message submission
  });
</script>
{% endblock content %}
{% block footer %}

{% endblock footer %}