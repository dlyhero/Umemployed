{% load static %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Phase</title>
    <link rel="stylesheet" scr="{% static 'build/css/style.css' %}" />
    <link rel="stylesheet" scr="{% static 'build/css/input.css' %}">
    <link
      rel="shortcut icon"
      href="build/logo/logo-color.png"
      type="image/x-icon"
    />
    <script src="https://cdn.tailwindcss.com"></script>

</head>
<body>
    <header
      class="flex justify-between items-center md:border-b top-0 right-0 left-0 px-2 md:px-5 py-2 mb-10 bg-white"
    >
      <div class="flex items-center gap-10">
        <div class="logo-wrap flex items-center">
          <img class="w-7 md:w-10" src="{% static 'build/logo/logo-color.png' %}" alt="" />
          <span class="text-[#1e90ff] hidden md:block md:text-xl font-bold"
            >UmEmployed</span
          >
        </div>
        <a class="hidden md:block" href="#">Home</a>
        <a class="hidden md:block" href="#">Jobs</a>
        <a class="hidden md:block" href="./index.html">Resume</a>
      </div>
      <nav class="flex md:gap-x-4 items-center">
        <ul class="flex gap-x-8 items-center">
          <li>
            <a href="#"
              ><img
                class="w-4 icon"
                src="{% static 'build/img/message-square-lines-svgrepo-com.svg' %}"
                alt="message icon"
            /></a>
          </li>
          <li>
            <a href="#"
              ><img
                class="w-4"
                src="{% static 'build/img/notification-bell-svgrepo-com.svg' %}"
                alt="notification icon"
            /></a>
          </li>
          <li class="hidden md:block">
            <a href="#"
              ><img
                class="w-4"
                src="{% static 'build/img/profile-svgrepo-com.svg' %}"
                alt="profile icon"
            /></a>
          </li>
          <li class="md:hidden">
            <button id="menu-btn" class="text-xl">
              <img class="w-4" src="{% static 'build/img/menu-svgrepo-com.svg' %}" alt="" />
            </button>
          </li>
        </ul>

        <div class="hidden md:block">
          |
          <span class="ml-4"><a href="#">Employers / Post Job</a> </span>
        </div>
      </nav>
      <div
        id="sidebar"
        class="font-bold fixed bg-[#8080803e] md:bg-none z-10 hidden top-0 bottom-0 left-0 right-0 p-10"
      >
        <div
          class="sidebar-conten h-fit p-2 bg-white rounded-lg absolute bottom-2 right-2 left-2 mx-auto md:hidden"
        >
          <div class="btn-wrap text-end">
            <button id="remove-btn" class="text-2xl text-end ml-auto mr-2">
              &times
            </button>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="#">Home </a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="./profile.html"
              >Profile
            </a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="./index.html"
              >Resume
            </a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="#">Jobs </a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="#">Settings </a>
          </div>
        </div>
      </div>
    </header>
    <div class="bg-gray-100 w-f mx-auto shadow-lg rounded-lg p-5 sm:w-3/4">
        <div id="header" class="flex justify-between mb-5">
            <h1 class="text-xl font-semibold">Test Your Skill</h1>
            <div id="timer" class="text-xl">Timer: 2:00</div>
        </div>
        <div class="sm:flex w-f">
           <div class="w-f sm:mr-8">
    <h2 class="font-semibold mb-2">Skills</h2>
    <ul class="flex flex-nowrap overflow-scroll sm:flex-col gap-2 overflow-x-auto overflow-y-auto">
        {% for skill in skills %}
            <li>
                <button class="skill-btn py-2 px-4 bg-blue-500 text-white rounded mb-2 w-[100px]" data-skill="{{ skill.id }}">{{ skill.name }}</button>
            </li>
        {% endfor %}
    </ul>
</div>

            <div class="w-f sm:w-3/4">
                <div id="question-section" class="p-5 border rounded bg-gray-50 ">
                    <h2 id="question-header" class="font-bold font-3xl mb-4 text-center">Question:</h2>
                    <form id="question-form" class="space-y-4" method="POST" action="{% url 'job:answer_job_questions' job.id %}">
                        {% csrf_token %}
                        <!-- Questions will be injected here -->
                        <div id="questions-container">
                            {% if mcqs %}
                                {% for question in mcqs %}
                                    <fieldset class="mb-2">
                                        <legend class="font-semibold mb-2">{{ question.question }}</legend>
                                        {% for option in question.options.all %}
                                            <label class="block mb-0">
                                                <input type="radio" name="question{{ question.id }}" value="{{ option.id }}" class="mr-2">
                                                {{ option.text }}
                                            </label>
                                        {% endfor %}
                                    </fieldset>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </form>
                </div>
                <div id="timer" class="mt-4 text-right text-lg font-bold"></div>
                <button id="next-btn" class="mt-4 py-2 px-4 bg-green-500 text-white rounded hidden">Next</button>
                <button id="submit-btn" class="mt-4 py-2 px-4 bg-red-500 text-white rounded hidden">Submit</button>
            </div>
        </div>
        
    </div>
    <script src="{% static 'assets_testing/JS/testing.js' %}"></script>
    <script>
    const jobId = "{{ job_id }}"; // Add job_id to JavaScript
    </script>
    
   <script>
    document.addEventListener("DOMContentLoaded", function () {
        const skillButtons = document.querySelectorAll(".skill-btn");
        const questionSection = document.getElementById("question-section");

        skillButtons.forEach(button => {
            button.addEventListener("click", () => {
                const skill = button.getAttribute("data-skill");
                saveResponses(); // Save previous responses if needed
                fetchQuestionsForSkill(skill); // Fetch questions for the selected skill
            });
        });

        function fetchQuestionsForSkill(skill) {
            // Send AJAX request to fetch questions for the selected skill
            const url = `/job/get_questions_for_skill/${skill}/`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Update question section with the fetched questions
                    displayQuestions(data.questions);
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                });
        }

        function displayQuestions(questions) {
            // Clear previous questions
            questionSection.innerHTML = "";

            // Render new questions
            questions.forEach(question => {
                console.log("Question:", question); // Debug: Log the question object

                const fieldset = document.createElement("fieldset");
                fieldset.classList.add("mb-2");

                // Check if question.options exists and is an array
                if (question.options && Array.isArray(question.options)) {
                    console.log("Options:", question.options); // Debug: Log the options array

                    fieldset.innerHTML = `
                        <legend class="font-semibold mb-2">${question.question}</legend>
                        ${question.options.map((option, index) => `
                            <label class="block mb-0">
                                <input type="radio" name="${question.id}" value="${String.fromCharCode(65 + index)}" class="mr-2">
                                ${option}
                            </label>
                        `).join("")}
                    `;
                } else {
                    // Handle case where options array is missing or empty
                    console.error("Error: Options array is missing or empty for question:", question);
                    fieldset.textContent = "Error: No options available";
                }

                questionSection.appendChild(fieldset);
            });
        }

        function saveResponses() {
            const responses = [];
            const responseInputs = document.querySelectorAll("input[type='radio']:checked");

            responseInputs.forEach(input => {
                responses.push({
                    question_id: input.name,
                    answer: input.value
                });
            });

            console.log("Responses collected for saving:", responses);

            const csrftoken = getCookie('csrftoken');
            console.log("CSRF Token for request:", csrftoken);

            fetch('/job/save_responses/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ 
                    responses: responses,
                    hello: 'Hello' // Adding 'hello' parameter
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("Response from fetch:", data);
                if (data.success) {
                    console.log('Responses saved successfully');
                    // Optionally handle success response here
                } else {
                    console.error('Error saving responses:', data.error);
                    // Optionally handle error response here
                }
            })
            .catch(error => {
                console.error('Error during saveResponses:', error);
                // Optionally handle fetch error here
            });
        }

        // Function to retrieve CSRF token from cookies
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    });
</script>

</body>
</html>

</body>

</html>
