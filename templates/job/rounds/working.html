{% load static %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testing Phase</title>
    <link rel="stylesheet" href="{% static 'build/css/style.css' %}" />
    <link
      rel="shortcut icon"
      href="{% static 'build/logo/logo-color.png' %}"
      type="image/x-icon"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Modal Styles */
        .modal-header {
            display: flex;
            justify-content: space-between; /* Space between elements */
            align-items: center; /* Center vertically */
            border-bottom: 1px solid #e5e7eb; /* Border bottom */
            padding-bottom: 10px; /* Padding bottom */
            margin-bottom: 10px; /* Margin bottom */
        }
        .modal-header h2 {
            font-size: 1.25rem; /* Font size */
            color: #374151; /* Text color */
        }
        .modal-header button {
            background: none; /* No background */
            border: none; /* No border */
            font-size: 1.5rem; /* Font size */
            color: #6b7280; /* Text color */
            cursor: pointer; /* Pointer cursor */
        }
        .modal-header button:hover {
            color: #111827; /* Hover color */
        }
        .modal-body {
            font-size: 1rem; /* Font size */
            color: #6b7280; /* Text color */
            margin-bottom: 20px; /* Margin bottom */
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end; /* Align items to end */
            margin-top: 10px; /* Margin top */
        }
        .modal-footer button {
            background-color: #3b82f6; /* Background color */
            color: white; /* Text color */
            padding: 8px 16px; /* Padding */
            border-radius: 4px; /* Rounded corners */
            border: none; /* No border */
            cursor: pointer; /* Pointer cursor */
            transition: background-color 0.3s; /* Transition */
        }
        .modal-footer button:hover {
            background-color: #2563eb; /* Hover color */
        }
        .modal-container {
            background-color: white; 
            border-radius: 8px; 
            padding: 20px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); 
            z-index: 9999; 
            max-width: 400px; 
            width: 100%; 
            position: relative; 
        }
    </style>
</head>
<body>
    <header
      class="flex justify-between items-center md:border-b top-0 right-0 left-0 px-2 md:px-5 py-2 mb-10 bg-white"
    >
      <div class="flex items-center gap-10">
        <div class="logo-wrap flex items-center">
          <img class="w-7 md:w-10" src="{% static 'build/logo/logo-color.png' %}" alt="" />
          <span class="text-[#1e90ff] hidden md:block md:text-xl font-bold">UmEmployed</span>
        </div>
        <a class="hidden md:block" href="{% url 'feature-not-implemented' %}">Home</a>
        <a class="hidden md:block" href="{% url 'feature-not-implemented' %}">Jobs</a>
        <a class="hidden md:block" href="./index.html">Resume</a>
      </div>
      <nav class="flex md:gap-x-4 items-center">
        <ul class="flex gap-x-8 items-center">
          <li>
            <a href="{% url 'feature-not-implemented' %}">
              <img
                class="w-4 icon"
                src="{% static 'build/img/message-square-lines-svgrepo-com.svg' %}"
                alt="message icon"
              />
            </a>
          </li>
          <li>
            <a href="{% url 'feature-not-implemented' %}">
              <img
                class="w-4"
                src="{% static 'build/img/notification-bell-svgrepo-com.svg' %}"
                alt="notification icon"
              />
            </a>
          </li>
          <li class="hidden md:block">
            <a href="{% url 'feature-not-implemented' %}">
              <img
                class="w-4"
                src="{% static 'build/img/profile-svgrepo-com.svg' %}"
                alt="profile icon"
              />
            </a>
          </li>
          <li class="md:hidden">
            <button id="menu-btn" class="text-xl">
              <img class="w-4" src="{% static 'build/img/menu-svgrepo-com.svg' %}" alt="" />
            </button>
          </li>
        </ul>
        <div class="hidden md:block">
          |
          <span class="ml-4"><a href="{% url 'feature-not-implemented' %}">Employers / Post Job</a></span>
        </div>
      </nav>
      <div
        id="sidebar"
        class="font-bold fixed bg-[#8080803e] md:bg-none z-10 hidden top-0 bottom-0 left-0 right-0 p-10"
      >
        <div
          class="sidebar-conten h-fit p-2 bg-white rounded-lg absolute bottom-2 right-2 left-2 mx-auto md:hidden"
        >
          <div class="btn-wrap text-end">
            <button id="remove-btn" class="text-2xl text-end ml-auto mr-2">
              &times
            </button>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="{% url 'feature-not-implemented' %}">Home </a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="./profile.html">Profile</a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="./index.html">Resume</a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="{% url 'feature-not-implemented' %}">Jobs</a>
          </div>
          <div class="nav-item font-bold p-2 border-b hover:bg-blue-50">
            <a class="flex justify-between items-center" href="{% url 'feature-not-implemented' %}">Settings</a>
          </div>
        </div>
      </div>
    </header>
    <div class="bg-gray-100 w-full mx-auto shadow-lg rounded-lg p-5 sm:w-3/4">
        <div id="header" class="flex justify-between mb-5">
            <h1 class="text-xl font-semibold">Test Your Skill</h1>
            <div id="timer" class="text-xl">Timer: 2:00</div>
        </div>
        <div class="sm:flex w-full">
            <div class="w-full sm:mr-8">
                <h2 class="font-semibold mb-2">Skills</h2>
                <ul class="flex flex-nowrap overflow-scroll sm:flex-col gap-2 overflow-x-auto overflow-y-auto">
                    {% for skill in skills %}
                        <li>
                            <button class="skill-btn py-2 px-4 bg-blue-500 text-white rounded mb-2 w-[100px]" data-skill="{{ skill.id }}">{{ skill.name }}</button>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="w-full sm:w-3/4">
                <div id="question-section" class="p-5 border rounded bg-gray-50">
                    <h2 id="question-header" class="font-bold font-3xl mb-4 text-center">Question:</h2>
                    <form id="question-form" class="space-y-4" method="POST" action="{% url 'job:answer_job_questions' job.id %}">
                        {% csrf_token %}
                        <!-- Questions will be injected here -->
                        <div id="questions-container">
                            {% if mcqs %}
                                {% for question in mcqs %}
                                    <fieldset class="mb-2">
                                        <legend class="font-semibold mb-2">{{ question.question }}</legend>
                                        {% for option in question.options.all %}
                                            <label class="block mb-0">
                                                <input type="radio" name="question{{ question.id }}" value="{{ option.id }}" class="mr-2">
                                                {{ option.text }}
                                            </label>
                                        {% endfor %}
                                    </fieldset>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </form>
                </div>
                <div id="timer" class="mt-4 text-right text-lg font-bold"></div>
                <button id="next-btn" class="mt-4 py-2 px-4 bg-green-500 text-white rounded hidden">Next</button>
                <button id="submit-btn" class="mt-4 py-2 px-4 bg-red-500 text-white rounded hidden">Submit</button>
            </div>
        </div>
    </div>
    <!-- Modal Structure -->
    <div id="completedSkillModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay fixed inset-0 bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white rounded-lg shadow-lg max-w-sm mx-auto p-6 z-50 relative">
            <div class="modal-header flex justify-between items-center border-b pb-2 mb-4">
                <h2 class="text-lg font-semibold text-gray-700">Skill Completed</h2>
                <button id="close-modal" class="text-gray-600 hover:text-gray-900 transition duration-150">&times;</button>
            </div>
            <div class="modal-body">
                <p class="text-gray-600">You have completed the current skill. Ready to move on to the next one?</p>
            </div>
            <div class="modal-footer flex justify-end mt-4">
                <button id="next-skill" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-150">Next Skill</button>
            </div>
        </div>
    </div>

    <script src="{% static 'assets_testing/JS/testing.js' %}"></script>

<script>
    const jobId = "{{ job.id }}"; // Add job_id to JavaScript

    document.addEventListener("DOMContentLoaded", function() {
        const skillButtons = document.querySelectorAll(".skill-btn");
        const nextBtn = document.getElementById("next-btn");
        const submitBtn = document.getElementById("submit-btn");
        const completedSkillModal = document.getElementById("completedSkillModal");
        const nextSkillBtn = document.getElementById("next-skill");
        const closeModalBtn = document.getElementById("close-modal");
        let currentSkillIndex = 0;

        skillButtons.forEach((button, index) => {
            button.addEventListener("click", () => {
                currentSkillIndex = index;
                const skill = button.getAttribute("data-skill");
                fetchQuestionsForSkill(skill);
            });
        });

        function fetchQuestionsForSkill(skill) {
            const url = `/job/get_questions_for_skill/${skill}/`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayQuestions(data.questions);
                    showNextOrSubmit(data.is_last_skill);
                })
                .catch(error => console.error('Error fetching questions:', error));
        }

        function displayQuestions(questions) {
            const questionsContainer = document.getElementById("questions-container");
            questionsContainer.innerHTML = questions.map(question => `
                <fieldset class="mb-2">
                    <legend class="font-semibold mb-2">${question.question}</legend>
                    ${question.options.map((option, index) => `
                        <label class="block mb-0">
                        <input type="radio" name="question${question.id}" value="${String.fromCharCode(65 + index)}" class="mr-2">
                        ${option}
                    </label>
                    `).join("")}
                </fieldset>
            `).join("");
        }

        function showNextOrSubmit(isLastSkill) {
            if (isLastSkill) {
                submitBtn.classList.remove("hidden");
                nextBtn.classList.add("hidden");
            } else {
                nextBtn.classList.remove("hidden");
                submitBtn.classList.add("hidden");
            }
        }

        nextBtn.addEventListener("click", () => {
            saveResponses(() => {
                completedSkillModal.classList.remove("hidden");
            });
        });

        nextSkillBtn.addEventListener("click", () => {
            completedSkillModal.classList.add("hidden");
            if (currentSkillIndex < skillButtons.length - 1) {
                skillButtons[currentSkillIndex + 1].click();
            }
        });

        closeModalBtn.addEventListener("click", () => {
            completedSkillModal.classList.add("hidden");
        });

        submitBtn.addEventListener("click", () => {
            saveResponses(() => {
                window.location.href = '/job/complete'; // Redirect to completion page
            });
        });

        function saveResponses(callback) {
            const responses = [];
            const responseInputs = document.querySelectorAll("input[type='radio']:checked");

            responseInputs.forEach(input => {
                responses.push({
                    question_id: input.name.replace('question', ''),
                    answer: input.value
                });
            });

            const skillId = skillButtons[currentSkillIndex].getAttribute("data-skill");
            const csrftoken = getCookie('csrftoken');

            fetch('/job/save_responses/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ skill_id: skillId, job_id: jobId, responses })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Responses saved successfully');
                    callback();
                } else {
                    console.error('Error saving responses:', data.error);
                }
            })
            .catch(error => console.error('Error during saveResponses:', error));
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
    });
</script>
</body>
</html>

</body>

</html>

